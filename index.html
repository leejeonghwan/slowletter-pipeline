<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>SlowLetter Finder.</title>
<script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>
<style>
  :root {
    --bg: #fafaf9; --surface: #ffffff; --border: #e7e5e4;
    --text: #1c1917; --text2: #57534e; --accent: #0369a1;
    --accent-bg: #e0f2fe; --tag-person: #fecdd3; --tag-org: #bbf7d0;
  }
  * { margin: 0; padding: 0; box-sizing: border-box; }
  body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif; background: var(--bg); color: var(--text); line-height: 1.6; }

  .header { background: var(--surface); border-bottom: 1px solid var(--border); padding: 1.5rem 2rem; }
  .header h1 { font-size: 1.4rem; font-weight: 700; }

  .controls { background: var(--surface); border-bottom: 1px solid var(--border); padding: 1rem 2rem; display: flex; flex-wrap: wrap; gap: 0.75rem; align-items: center; }
  .search-box { flex: 1; min-width: 200px; padding: 0.5rem 0.75rem; border: 1px solid var(--border); border-radius: 6px; font-size: 0.9rem; outline: none; }
  .search-box:focus { border-color: var(--accent); box-shadow: 0 0 0 2px var(--accent-bg); }

  .stats { padding: 0.75rem 2rem; font-size: 0.8rem; color: var(--text2); background: var(--bg); display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 0.5rem; }

  .content { max-width: 900px; padding: 1rem 2rem 3rem; }

  .article { background: var(--surface); border: 1px solid var(--border); border-radius: 8px; padding: 1.25rem; margin-bottom: 0.75rem; transition: box-shadow 0.15s; }
  .article:hover { box-shadow: 0 2px 8px rgba(0,0,0,0.06); }
  .article-date { font-size: 0.75rem; color: var(--text2); margin-bottom: 0.25rem; }
  .article-title { font-size: 1rem; font-weight: 600; margin-bottom: 0.5rem; }
  .article-snippet { font-size: 0.85rem; color: var(--text2); margin-bottom: 0.75rem; display: -webkit-box; -webkit-line-clamp: 5; -webkit-box-orient: vertical; overflow: hidden; }
  .article-snippet a { color: var(--accent); text-decoration: none; }
  .article-snippet a:hover { text-decoration: underline; }
  .article-snippet.expanded { -webkit-line-clamp: unset; }
  .expand-btn { font-size: 0.75rem; color: var(--accent); cursor: pointer; border: none; background: none; padding: 0; margin-bottom: 0.5rem; }

  .tags { display: flex; flex-wrap: wrap; gap: 0.35rem; }
  .tag { display: inline-block; padding: 0.15rem 0.5rem; border-radius: 12px; font-size: 0.7rem; cursor: pointer; }
  .tag:hover { opacity: 0.8; filter: brightness(0.95); }
  .tag-person { background: var(--tag-person); }
  .tag-org { background: var(--tag-org); }

  .pagination { display: flex; gap: 0.5rem; margin-top: 1.5rem; flex-wrap: wrap; }
  .page-btn { padding: 0.4rem 0.8rem; border: 1px solid var(--border); border-radius: 6px; background: var(--surface); cursor: pointer; font-size: 0.85rem; }
  .page-btn:hover { background: #f5f5f4; }
  .page-btn.active { background: var(--accent); color: white; border-color: var(--accent); }
  .page-btn:disabled { opacity: 0.4; cursor: default; }

  .loading { text-align: center; padding: 4rem 2rem; }
  .loading-spinner { display: inline-block; width: 32px; height: 32px; border: 3px solid var(--border); border-top-color: var(--accent); border-radius: 50%; animation: spin 0.8s linear infinite; }
  @keyframes spin { to { transform: rotate(360deg); } }
  .loading-text { margin-top: 1rem; color: var(--text2); font-size: 0.9rem; }
  .progress-bar { width: 200px; height: 4px; background: var(--border); border-radius: 2px; margin: 0.75rem auto 0; overflow: hidden; }
  .progress-fill { height: 100%; background: var(--accent); transition: width 0.3s; border-radius: 2px; }

  @media (max-width: 640px) {
    .controls { padding: 0.75rem 1rem; }
    .content { padding: 0.75rem 1rem 3rem; }
    .stats { padding: 0.5rem 1rem; }
    .header { padding: 1.2rem 1rem; }
  }
</style>
</head>
<body>

<div class="header">
  <h1>SlowLetter Finder.</h1>
</div>

<div class="controls">
  <input type="text" class="search-box" id="searchInput" placeholder="검색어 입력 (제목, 내용, 인물, 조직...)">
</div>

<div class="stats" id="stats">
  <span>데이터 로딩 중...</span>
</div>

<div class="content" id="content">
  <div class="loading" id="loading">
    <div class="loading-spinner"></div>
    <div class="loading-text">데이터를 불러오는 중...</div>
    <div class="progress-bar"><div class="progress-fill" id="progressFill" style="width:0%"></div></div>
  </div>
</div>

<script>
const PER_PAGE = 30;
let allData = [];
let filtered = [];
let currentPage = 1;
let searchDebounce = null;

function parseEntities(str) {
  if (!str || str.trim() === '') return [];
  return str.split(';').map(s => s.trim()).filter(s => s.length > 0);
}

function loadData() {
  const csvPath = 'data/raw/slowletter_solar_entities.csv';
  let rowCount = 0;

  Papa.parse(csvPath, {
    download: true,
    header: true,
    skipEmptyLines: true,
    chunk: function(results) {
      for (const row of results.data) {
        if (!row.title || !row.date) continue;
        const item = {
          id: row.ID || '',
          date: row.date ? row.date.substring(0, 10) : '',
          title: row.title || '',
          content: row.cleaned_content_for_service || '',
          persons: parseEntities(row.solar_persons),
          orgs: parseEntities(row.solar_organizations),
        };
        item._search = (item.title + ' ' + item.content + ' ' +
          item.persons.join(' ') + ' ' + item.orgs.join(' ')).toLowerCase();
        allData.push(item);
      }
      rowCount += results.data.length;
      const pct = Math.min(95, Math.round(rowCount / 180));
      document.getElementById('progressFill').style.width = pct + '%';
    },
    complete: function() {
      document.getElementById('progressFill').style.width = '100%';
      allData.sort((a, b) => b.date.localeCompare(a.date));
      applyFilters();
      document.getElementById('loading').style.display = 'none';
    },
    error: function(err) {
      document.getElementById('loading').innerHTML =
        '<div style="color:#dc2626">CSV 파일을 불러올 수 없습니다.<br><small>' + err.message + '</small></div>';
    }
  });
}

function applyFilters() {
  const query = document.getElementById('searchInput').value.toLowerCase().trim();

  filtered = allData.filter(item => {
    if (query && !item._search.includes(query)) return false;
    return true;
  });

  currentPage = 1;
  render();
}

function render() {
  const totalPages = Math.ceil(filtered.length / PER_PAGE);
  const start = (currentPage - 1) * PER_PAGE;
  const pageItems = filtered.slice(start, start + PER_PAGE);

  document.getElementById('stats').innerHTML =
    `<span>전체 ${allData.length.toLocaleString()}건 가운데 ${filtered.length.toLocaleString()}건.</span>
     <span>${currentPage} / ${Math.max(1, totalPages)}</span>`;

  const contentEl = document.getElementById('content');
  if (pageItems.length === 0) {
    contentEl.innerHTML = '<div style="text-align:left;padding:3rem 0;color:#a8a29e">검색 결과가 없습니다</div>';
    return;
  }

  let html = '';
  for (const item of pageItems) {
    const formattedContent = formatContent(item.content);
    html += `<div class="article">
      <div class="article-date">${item.date}</div>
      <div class="article-title">${escapeHtml(item.title)}</div>
      <div class="article-snippet" id="snippet-${item.id}">${formattedContent}</div>
      ${item.content.length > 150 ? `<button class="expand-btn" onclick="toggleSnippet('${item.id}')">더보기</button>` : ''}
      <div class="tags">
        ${renderTags(item.persons, 'person')}
        ${renderTags(item.orgs, 'org')}
      </div>
    </div>`;
  }

  html += '<div class="pagination">';
  html += `<button class="page-btn" onclick="goPage(1)" ${currentPage === 1 ? 'disabled' : ''}>&laquo;</button>`;
  html += `<button class="page-btn" onclick="goPage(${currentPage - 1})" ${currentPage === 1 ? 'disabled' : ''}>&lsaquo;</button>`;

  const maxVisible = 5;
  let pStart = Math.max(1, currentPage - Math.floor(maxVisible / 2));
  let pEnd = Math.min(totalPages, pStart + maxVisible - 1);
  if (pEnd - pStart < maxVisible - 1) pStart = Math.max(1, pEnd - maxVisible + 1);

  for (let i = pStart; i <= pEnd; i++) {
    html += `<button class="page-btn ${i === currentPage ? 'active' : ''}" onclick="goPage(${i})">${i}</button>`;
  }

  html += `<button class="page-btn" onclick="goPage(${currentPage + 1})" ${currentPage >= totalPages ? 'disabled' : ''}>&rsaquo;</button>`;
  html += `<button class="page-btn" onclick="goPage(${totalPages})" ${currentPage >= totalPages ? 'disabled' : ''}>&raquo;</button>`;
  html += '</div>';

  contentEl.innerHTML = html;
}

function formatContent(text) {
  // Content now has • bullets, \n line breaks, and <a href> links
  // Escape HTML except for our trusted <a> tags
  // 1) Extract <a> tags, replace with placeholders
  const links = [];
  let safe = text.replace(/<a\s+href="([^"]*)">(.*?)<\/a>/g, (m, href, label) => {
    links.push({href, label});
    return `%%LINK${links.length - 1}%%`;
  });
  // 2) Escape remaining HTML
  const d = document.createElement('div');
  d.textContent = safe;
  safe = d.innerHTML;
  // 3) Restore links
  safe = safe.replace(/%%LINK(\d+)%%/g, (m, i) => {
    const l = links[parseInt(i)];
    return `<a href="${l.href}" target="_blank" rel="noopener">${escapeHtml(l.label)}</a>`;
  });
  // 4) Line breaks
  safe = safe.replace(/\n/g, '<br>');
  return safe;
}

function renderTags(entities, type) {
  const info = TYPE_MAP[type];
  return entities.map(e =>
    `<span class="tag ${info.cls}" onclick="searchEntity('${escapeAttr(e)}')" title="${info.label}: ${escapeAttr(e)}">${escapeHtml(e)}</span>`
  ).join('');
}

function escapeHtml(s) {
  const d = document.createElement('div');
  d.textContent = s;
  return d.innerHTML;
}

function escapeAttr(s) {
  return s.replace(/'/g, "\\'").replace(/"/g, '&quot;');
}

function toggleSnippet(id) {
  const el = document.getElementById('snippet-' + id);
  if (el) {
    el.classList.toggle('expanded');
    const btn = el.nextElementSibling;
    if (btn) btn.textContent = el.classList.contains('expanded') ? '접기' : '더보기';
  }
}

function searchEntity(name) {
  document.getElementById('searchInput').value = name;
  applyFilters();
  window.scrollTo({ top: 0, behavior: 'smooth' });
}

function goPage(n) {
  const totalPages = Math.ceil(filtered.length / PER_PAGE);
  currentPage = Math.max(1, Math.min(n, totalPages));
  render();
  window.scrollTo({ top: 0, behavior: 'smooth' });
}

// Event listeners
document.getElementById('searchInput').addEventListener('input', () => {
  clearTimeout(searchDebounce);
  searchDebounce = setTimeout(applyFilters, 300);
});

document.addEventListener('keydown', (e) => {
  if (e.key === '/' && document.activeElement.tagName !== 'INPUT') {
    e.preventDefault();
    document.getElementById('searchInput').focus();
  }
});

loadData();
</script>
</body>
</html>
